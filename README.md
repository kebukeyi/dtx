# dtx
TCC、RocketMQ实现可靠消息、最大努力通知方案解决的分布式事务。

## 分布式事务
### 问题举例
传统单机项目，可以依靠一个MySQL进程实例的事务来保证项目的事务；如今的微服务项目，可能会出现如订单服务、积分服务2个微服务分别对应2个不同的数据库实例，当出现订单入库成功，积分服务入库成功，但是由于网络原因积分服务返回值未能在有效时间内到达订单服务，就会出现订单服务执行回滚操作，导致数据不一致；或者1个订单服务使用了订单数据库和积分数据库2个数据库，存在两个数据库连接，当有一个失败时，另外一个也是不能回滚；再或者订单服务、积分服务2个服务共用了同1个数据库，当订单服务失败时，积分服务也是无法回滚；

### CAP理论支持
C 代表着数据一致性，由于我们现在的服务量很大，因此会采用读写分离策略来提供对外服务，采用读写分离后，用户甲在A库中的写入操作，用户甲在B库读取到的也应该是最新的数据，也就是写库要实时的把数据同步到读库中，但是需要锁住从库；我们在此要求下，只能返回最新的数据或者延迟响应，就是不能返回旧数据；
A 代表着可用性，所有的事务请求都可以得到响应，数据一致性出错没关系，不能出现响应超时或者错误；就相当于从数据库中的查询请求需要立即响应结果；不允许出现响应超时或者响应错误；在同步数据过程中，从数据库不能进行锁资源，但是可以返回一个旧数据或者返回一个默认的消息，就是不能返回错误信息；
P 代表着分区容忍性，分区叫做网络分区，数据库部署在不同的子网中；容忍性：由于网络原因导致分区之间的A、B服务不能正常通信了，但是A、B两个服务仍然可以对外提供服务；可以提供多个A、B服务为了宕机补位；是分布式系统的基本具备能力；

### BASE理论补充
base是 基本可用、软状态、最终一致性的概括；是对AP的一个扩展；通过牺牲强一致性来获得可用性，但不是强可用性，当服务出现故障时允许不可用但是核心功能可用；允许数据在一段时间内不一致，但是最终需要一致，满足BASE理论的事务，我们称之为 “柔性事务”；

## 解决方案
### 2PC

### Seata

### TCC
try、commit、cancel；对应三个阶段，其实第一阶段需要各个本地事务都try成功了，并且默认也都confirm成功了，TCC事务框架会自动识别到confirm/cancel，执行最后全局事务的回滚或者提交；
因此我们只要暴露一个对应的try方法的事务开始入口即可；

### 可靠消息最终一致性
事务发起方执行完本地事务后并发出一条消息，事务的参与方（消费者）一定能够接收到消息并且处理事务成功，只要消息发送给对方，那么事务最终一定要一致；
1.本地事务跟消息发送的原子性问题：本地事务执行成功、消息必须成功，不容易实现；
2.事务方的参数方接受消息的可靠性：消息重发机制、重复消费问题；
3.事务方的参数方如何一定能消费到消息：当消费者消费完信息会发送ack跟MQ进行确认消费；
* 本地消息表方案
在本地新建一个积分消息表，由于注册表跟积分消息表是在同一个本地事务中，所以会同时执行成功，随后定时扫描本地消息表，向MQ发送数据；消费者去监听队列消费消息；
* RocketMQ事务消息
在4.3版本之后实现了事务消息机制，实际上是对本地消息表的一个封装，将本地消息表移动到了MQ内部，解决了Producer端的消息发送与本地事务执行的原子性问题；首先事务的发起方Producer得向MQ中发送一条“半”消息(张三+30元)，随后MQ收到消息并持久化后需要向Producer发送“半”消息发送成功消息，这时Producer需要在本地执行事务，然后再向MQ发送本地执行事务的结果，倘如执行失败，那么MQ就会删除之前发送的“半”消息；倘若执行成功，那么MQ就会发送数据到消费者那端执行事务，倘若失败了，就进入重试机制，当当达到一定阙值时，这时再人工介入；倘若Producer由于网络故障或者gc没有及时向MQ发送事务执行结果，那么MQ就会执行事务回查机制，那么我们就需要手动实现事务回查机制，MQ会根据事务回查机制来决定“半”消息的去留；

### 最大努力通知
账户系统调用充值系统接口，账户系统就要把充值结果尽最大努力把消息传递给账号系统，账户系统收到了就要更改状态，没有收到就要主动发起查询充值系统的接口进行查询充值结果；
1. 要有一定的消息重复通知机制
2. 消息被查询进行校对机制

#### 最大努力通知跟可靠消息最终一致性的区别
* 解决方案方向不同：可靠消息一致性是发送方保证消息可靠的发在了mq中，并且可靠的发送给了消费方；最大努力通知是 通知方要尽最大努力通知到发送方，比如充值操作，倘若一直充值失败就会重试，充值成功了就往mq中发送数据，通知对对方结果，但是这里就不保证消息的可靠性了；如果发送方一直没有收到信息，发送方就会主动发起查询接口进行查询充值结果；

